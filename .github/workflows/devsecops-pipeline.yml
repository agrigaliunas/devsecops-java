name: DevSecOps Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  security:
    name: Build, SAST, SCA & DAST
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build application
        run: mvn -B -DskipTests clean package

      - name: Run SpotBugs (SAST)
        run: mvn -B spotbugs:spotbugs
        continue-on-error: true

      - name: Upload SpotBugs report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spotbugs-report
          path: target/spotbugsXml.xml

      - name: Run OWASP Dependency-Check (SCA)
        run: mvn -B org.owasp:dependency-check-maven:check
        continue-on-error: true

      - name: Upload Dependency-Check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: target/dependency-check-report.*

      - name: Start application for DAST
        run: |
          nohup mvn -DskipTests spring-boot:run > app.log 2>&1 &
          echo $! > app.pid
          set +e
          python3 <<'PY'
import socket
import time
import sys

for _ in range(30):
    try:
        with socket.create_connection(("127.0.0.1", 8080), timeout=2):
            print("Application is up")
            sys.exit(0)
    except OSError:
        time.sleep(2)

print("Application failed to start", file=sys.stderr)
sys.exit(1)
PY
          status=$?
          set -e
          if [ $status -ne 0 ]; then
            echo "Application failed to start" >&2
            cat app.log >&2
            exit $status
          fi

      - name: Run OWASP ZAP Baseline (DAST)
        uses: zaproxy/action-baseline@v0.11.0
        continue-on-error: true
        with:
          target: 'http://localhost:8080'

      - name: Stop application
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
          fi
          if [ -f app.log ]; then
            cat app.log
          fi

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report
          path: '**/zap-baseline-report.*'
